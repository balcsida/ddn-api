# API endpoints of CloudDB
All API endpoints return json objects with a status and a named payload of either string, list or map.

## GET api/list
Example `curl http://localhost:7010/api/list`

### Payload
none

### Returns
Map of agents, shortName being the key, database vendor being the value.

Example return:
```
{
   "status":100,
   "map":{
      "mariadb-10":"mariadb"
   }
}
```
### Notes
Deprecated in favour of `api/list-agents`


## GET api/list-agents
Example call: `curl http://localhost:7010/api/list-agents`

### Payload
none

### Returns
Map of agents, shortName being the key, the value being an object containing all known information.

Example return:

```
{
   "mariadb-10":{
      "id":1,
      "vendor":"mariadb",
      "dbport":"3309",
      "dbaddress":"localhost",
      "sid":"",
      "agent":"mariadb-10",
      "agent_long":"mariadb 10.2.11",
      "agent_identifier":"myhostname-mariadb-10",
      "agent_port":"7005",
      "agent_version":"3",
      "agent_address":"http://localhost",
      "agent_token":"",
      "agent_up":true
   }
}
```

## POST api/list-databases
Returns with the list of databases the user has and all the public ones. POST JSON request requires `requester` field.

If requester does not have private databases, the public ones are still returned.

example call:
`curl -H "Content-Type: application/json" -X POST -d '{"requester":"daniel.javorszky@liferay.com"}' http://localhost:7010/api/list-databases`

### Payload
`requester` - email address of the user in question.

### Returns
Returns a map of objects, where the "id" of the database is the key and the object itself is the value.

Example return:
```
{
   "15":{
      "id":15,
      "vendor":"mariadb",
      "dbname":"gel_component",
      "dbuser":"performance_air",
      "dbpass":"gel_gel",
      "sid":"",
      "dumplocation":"",
      "createdate":"2017-12-11T15:14:27.03707071Z",
      "expirydate":"2018-01-11T15:14:27.037070856Z",
      "creator":"daniel.javorszky@liferay.com",
      "agent":"mariadb-10",
      "dbaddress":"172.17.0.2",
      "dbport":"3309",
      "status":100,
      "comment":"",
      "message":"",
      "public":0
   },
}
```

Failing can happen if JSON request is malformed:
```
{
   "status":400,
   "message":"ERR_JSON_DECODE_FAILED"
}
```

## GET api/agents/${agent_identifier}
Returns all information about a specific agent, similarly to how `api/list-agents` returns them for all of them. Agent identifiers are alphanumeric with dashes or underscores (`[a-zA-Z0-9-_]+`).

Example call:
`curl http://localhost:7010/api/agents/mariadb-10`

### Payload
none

### Returns
If agent is found, returns all known information:
```
{
   "id":3,
   "vendor":"mariadb",
   "dbport":"3309",
   "dbaddress":"172.17.0.2",
   "sid":"",
   "agent":"mariadb-10",
   "agent_long":"mariadb 10.2.11",
   "agent_identifier":"myhostname-mariadb-10",
   "agent_port":"7005",
   "agent_version":"3",
   "agent_address":"http://172.17.0.2",
   "agent_token":"",
   "agent_up":true
}
```

If failed, error message returned:
```
{
   "status":503,
   "message":"ERR_AGENT_NOT_FOUND"
}
```

## POST api/create
API JSON call to create a database. There are two required fields: `agent_identifier` and `requester_email`, the rest are optional. The `id` field is autogenerated even when set, as it's used for internal communication and housekeeping. As such, the response may contain a different `id` then a request. 

Example call:

```
curl -H "Content-Type: application/json" -X POST -d '{"agent_identifier":"mariadb-10","requester_email":"daniel.javorszky@liferay.com"}' http://localhost:7010/api/create

```

### Payload
The following fields can be sent in the JSON call:
```
"id" // ignored
"database_name" // name of the database to be set. Ignored in case of oracle.
"dumpfile_location" // ignored in case of create database
"username" // user to be created along with the database. Ignored in case of mssql.
"password" // user's password. Ignored in case of mssql.
"agent_identifier" // Agent's identifier. See `api/list-agents`
"requester_email" // requester's email address
```

### Returns
If successful, returns JSON object with all necessary information:

```
{
   "id":16,
   "vendor":"mariadb",
   "dbname":"electric_adapter",
   "dbuser":"electric_adapter",
   "dbpass":"tag_tuner",
   "sid":"",
   "dumplocation":"",
   "createdate":"2018-01-07T13:25:46.148399484Z",
   "expirydate":"2018-02-07T13:25:46.148399558Z",
   "creator":"daniel.javorszky@liferay.com",
   "agent":"mariadb-10",
   "dbaddress":"172.17.0.2",
   "dbport":"3309",
   "status":100,
   "comment":"",
   "message":"",
   "public":0
}
```

If failed, returns a failure message containing a `status` and a `message`:
```
{
   "status":305,
   "message":"creating database failed: sending json message failed: got non-200 response '500' and message: {\"status\":305,\"message\":\"creating database \\\"electric_adapter\\\" failed: database 'electric_adapter' already exists\"}"
}
```


## GET api/loglevel/${level}
Change the loglevel of the server. Possible values are:

Example call:
`curl http://localhost:7010/api/loglevel/debug`

### Payload
Possible values for ${level}:
```
fatal
error
warn
info
debug
```

### Response
If successful:
```
{
   "status":200,
   "message":"Loglevel changed from info to debug"
}
```

If failed:

```
{
   "status":400,
   "message":"ERR_UNRECOGNIZED_LOGLEVEL"
}
```

## GET api/visibility/${id}/${level}
Change the visibility of a database.

Currently broken, needs fix.

## GET api/safe2restart
Returns a map that says whether the server and agents are safe to be restarted. At the moment, it only checks if there are any imports happening.

Example call:

### Payload
none

### Response
```
{
   "status":200,
   "map":{
      "mariadb-10":"yes",
      "server":"yes"
   }
}
```


## GET api/dbaccess/${requester}/${agent_identifier}/${dbname}
Returns a map of database access details.
Example call:
`curl localhost:7010/api/dbaccess/daniel.javorszky@liferay.com/mariadb-10/electric_adapter`

### Payload
`requester` is an email address

`agent_identifier` identifies the agent

`dbname` is the name of the database

### Response

```
{
   "status":100,
   "map":{
      "jdbc-driver":"jdbc.default.driverClassName=org.mariadb.jdbc.Driver",
      "jdbc-url":"jdbc.default.url=jdbc:mariadb://172.17.0.2:3309/electric_adapter?useUnicode=true\u0026characterEncoding=UTF-8\u0026useFastDateParsing=false",
      "password":"tag_tuner",
      "url":"172.17.0.2:3309",
      "user":"electric_adapter"
   }
}
```

